<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - ShopKart</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .chat-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            height: calc(100vh - 60px);
            gap: 0;
        }

        .chat-sidebar {
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        .chat-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .chat-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-item:hover {
            background: #f5f5f5;
        }

        .chat-item.active {
            background: #fb641b;
            color: white;
        }

        .chat-item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chat-item-preview {
            font-size: 12px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item.active .chat-item-preview {
            color: rgba(255, 255, 255, 0.8);
        }

        .chat-main {
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background: white;
        }

        .chat-header h3 {
            margin: 0;
            color: #333;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 60%;
            padding: 12px 15px;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .message.received .message-bubble {
            background: #f0f0f0;
            color: #333;
        }

        .message.sent .message-bubble {
            background: #fb641b;
            color: white;
        }

        .message-time {
            font-size: 12px;
            color: #999;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            resize: none;
        }

        .btn-send {
            padding: 12px 20px;
            background: #fb641b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }

        .btn-send:hover {
            background: #e55a12;
        }

        .empty-chat {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            text-align: center;
        }
    </style>
</head>
<body style="margin: 0; background: #f5f5f5;">
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="index.html" class="logo">ShopKart <span>Chat</span></a>
            <div class="nav-links">
                <a href="buy-dashboard.html">ðŸ’³ Buy</a>
                <a href="seller-dashboard.html">ðŸ“¦ Sell</a>
                <a href="orders.html">ðŸ›’ Orders</a>
                <a href="profile.html">ðŸ‘¤ Profile</a>
                <a href="#" onclick="logout()" style="background: #fb641b; padding: 8px 20px;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="chat-container">
        <!-- Chat Sidebar -->
        <div class="chat-sidebar">
            <div style="padding: 15px; border-bottom: 1px solid #ddd;">
                <h3 style="margin: 0; color: #333;">Messages</h3>
            </div>
            <ul class="chat-list" id="chatList"></ul>
        </div>

        <!-- Chat Main -->
        <div class="chat-main">
            <div class="chat-header">
                <h3 id="chatName">Select a conversation</h3>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="empty-chat">
                    <p>Select a conversation to start chatting</p>
                </div>
            </div>

            <div class="chat-input-area">
                <textarea class="chat-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                <button class="btn-send" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        const API_URL = 'http://localhost:8080/api';
        let currentChatUserId = null;
        let userChats = [];
        const currentUser = JSON.parse(localStorage.getItem('user'));

        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            } else {
                // Check URL params for seller ID
                const params = new URLSearchParams(window.location.search);
                const sellerId = params.get('sellerId');
                if (sellerId) {
                    currentChatUserId = sellerId;
                    document.getElementById('chatName').textContent = 'Seller Chat';
                    loadConversation(currentUser.id, sellerId);
                } else {
                    loadUserChats();
                }
            }
        });

        async function loadUserChats() {
            try {
                const response = await fetch(`${API_URL}/chat/${currentUser.id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                userChats = await response.json();

                const chatList = document.getElementById('chatList');
                if (userChats.length === 0) {
                    chatList.innerHTML = '<li style="padding: 20px; text-align: center; color: #999;">No conversations yet</li>';
                    return;
                }

                // Get unique users from chats
                const uniqueUsers = [...new Set(userChats.map(c => c.senderId === currentUser.id ? c.receiverId : c.senderId))];

                chatList.innerHTML = uniqueUsers.map(userId => {
                    const lastMessage = userChats.filter(c => (c.senderId === userId || c.receiverId === userId))
                        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                    
                    return `
                        <li class="chat-item" onclick="selectChat(${userId}, 'User ${userId}')">
                            <div class="chat-item-name">User ${userId}</div>
                            <div class="chat-item-preview">${lastMessage.message.substring(0, 30)}...</div>
                        </li>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading chats:', error);
            }
        }

        function selectChat(userId, userName) {
            currentChatUserId = userId;
            document.getElementById('chatName').textContent = userName;
            
            // Update active state
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.chat-item').classList.add('active');

            loadConversation(currentUser.id, userId);
        }

        async function loadConversation(userId1, userId2) {
            try {
                const response = await fetch(`${API_URL}/chat/conversation?userId1=${userId1}&userId2=${userId2}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const messages = await response.json();

                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = messages.map(msg => `
                    <div class="message ${msg.senderId === currentUser.id ? 'sent' : 'received'}">
                        <div class="message-bubble">${msg.message}</div>
                        <div class="message-time">${new Date(msg.createdAt).toLocaleTimeString()}</div>
                    </div>
                `).join('');

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } catch (error) {
                console.error('Error loading conversation:', error);
            }
        }

        async function sendMessage() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message || !currentChatUserId) return;

            try {
                const response = await fetch(`${API_URL}/chat?senderId=${currentUser.id}&receiverId=${currentChatUserId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ message })
                });

                if (response.ok) {
                    document.getElementById('messageInput').value = '';
                    loadConversation(currentUser.id, currentChatUserId);
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Auto-load chats periodically
        setInterval(() => {
            if (!currentChatUserId) {
                loadUserChats();
            } else {
                loadConversation(currentUser.id, currentChatUserId);
            }
        }, 3000);

        // Send on Enter key
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>
