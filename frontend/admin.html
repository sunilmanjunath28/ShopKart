<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - ShopKart</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
            gap: 20px;
            padding: 20px;
            background: #f5f5f5;
        }

        .admin-sidebar {
            background: #2c3e50;
            padding: 20px;
            border-radius: 8px;
            height: fit-content;
        }

        .admin-sidebar h2 {
            color: white;
            margin-top: 0;
        }

        .admin-sidebar a {
            display: block;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            text-decoration: none;
            color: white;
            transition: all 0.3s;
        }

        .admin-sidebar a:hover,
        .admin-sidebar a.active {
            background: #fb641b;
        }

        .admin-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .users-table,
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th,
        .products-table th {
            background: #fb641b;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .users-table td,
        .products-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        .users-table tr:hover,
        .products-table tr:hover {
            background: #f5f5f5;
        }

        .btn-ban,
        .btn-unban,
        .btn-remove {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            margin-right: 5px;
        }

        .btn-ban {
            background: #f44336;
            color: white;
        }

        .btn-unban {
            background: #4CAF50;
            color: white;
        }

        .btn-remove {
            background: #ff9800;
            color: white;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            padding: 10px;
            width: 300px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-active {
            background: #d1e7dd;
            color: #0f5132;
        }

        .badge-inactive {
            background: #f8d7da;
            color: #842029;
        }

        .badge-banned {
            background: #f8d7da;
            color: #842029;
        }
    </style>
</head>
<body style="background: #f5f5f5;">
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="index.html" class="logo">ShopKart <span>Admin</span></a>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="#" id="adminName">Admin Panel</a>
                <a href="#" onclick="logout()" style="background: #fb641b; padding: 8px 20px;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <h2>Admin Menu</h2>
            <a href="#" class="menu-item active" data-section="dashboard">üìä Dashboard</a>
            <a href="#" class="menu-item" data-section="users">üë• Manage Users</a>
            <a href="#" class="menu-item" data-section="products">üì¶ Manage Products</a>
            <a href="#" class="menu-item" data-section="categories">üìÇ Categories</a>
            <a href="#" class="menu-item" data-section="reports">üìà Reports</a>
        </div>

        <!-- Main Content -->
        <div class="admin-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <h2>üìä Dashboard</h2>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stat-label">Total Products</div>
                        <div class="stat-value" id="totalProducts">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stat-label">Total Orders</div>
                        <div class="stat-value" id="totalOrders">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <div class="stat-label">Banned Users</div>
                        <div class="stat-value" id="bannedUsers">0</div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users" class="section">
                <h2>üë• Manage Users</h2>
                <div class="search-box">
                    <input type="text" id="userSearch" placeholder="Search users by email or name..." onkeyup="searchUsers()">
                </div>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Rating</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="7" style="text-align: center;">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Products Section -->
            <div id="products" class="section">
                <h2>üì¶ Manage Products</h2>
                <div class="search-box">
                    <input type="text" id="productSearch" placeholder="Search products by name..." onkeyup="searchProducts()">
                </div>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Seller</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr><td colspan="7" style="text-align: center;">Loading products...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Categories Section -->
            <div id="categories" class="section">
                <h2>üìÇ Categories</h2>
                <div style="margin: 20px 0;">
                    <input type="text" id="newCategory" placeholder="Category name" style="padding: 10px;">
                    <button onclick="addCategory()" style="padding: 10px 20px; background: #fb641b; color: white; border: none; border-radius: 5px; cursor: pointer;">Add Category</button>
                </div>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Category Name</th>
                            <th>Products</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesTableBody">
                        <tr><td colspan="3" style="text-align: center;">Loading categories...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Reports Section -->
            <div id="reports" class="section">
                <h2>üìà Reports</h2>
                <p>System reports and analytics coming soon...</p>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        const API_URL = 'http://localhost:8080/api';
        let allUsers = [];
        let allProducts = [];

        // Sidebar navigation
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const section = item.dataset.section;
                
                // Hide all sections
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(section).classList.add('active');
                
                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                item.classList.add('active');

                // Load section data
                if (section === 'dashboard') loadDashboard();
                if (section === 'users') loadUsers();
                if (section === 'products') loadProducts();
                if (section === 'categories') loadCategories();
            });
        });

        // Load dashboard stats
        async function loadDashboard() {
            try {
                const usersResponse = await fetch(`${API_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                }).catch(() => ({ json: () => [] }));
                
                const productsResponse = await fetch(`${API_URL}/products`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                }).catch(() => ({ json: () => [] }));
                
                const ordersResponse = await fetch(`${API_URL}/orders`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                }).catch(() => ({ json: () => [] }));

                const users = await usersResponse.json() || [];
                const products = await productsResponse.json() || [];
                const orders = await ordersResponse.json() || [];

                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalProducts').textContent = products.length;
                document.getElementById('totalOrders').textContent = orders.length;
                document.getElementById('bannedUsers').textContent = users.filter(u => u.banned).length;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                allUsers = await response.json() || [];
                displayUsers(allUsers);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Display users
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td><span class="badge ${user.banned ? 'badge-banned' : 'badge-active'}">${user.banned ? 'Banned' : 'Active'}</span></td>
                    <td>${user.ratings.toFixed(1)} ‚≠ê</td>
                    <td>
                        ${user.banned ? 
                            `<button class="btn-unban" onclick="unbanUser(${user.id})">Unban</button>` :
                            `<button class="btn-ban" onclick="banUser(${user.id})">Ban</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        // Search users
        function searchUsers() {
            const keyword = document.getElementById('userSearch').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                u.name.toLowerCase().includes(keyword) || 
                u.email.toLowerCase().includes(keyword)
            );
            displayUsers(filtered);
        }

        // Load products
        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/products`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                allProducts = await response.json() || [];
                displayProducts(allProducts);
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Display products
        function displayProducts(products) {
            const tbody = document.getElementById('productsTableBody');
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No products found</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>Seller #${product.sellerId}</td>
                    <td>‚Çπ${product.price}</td>
                    <td>${product.stock}</td>
                    <td><span class="badge ${product.status === 'ACTIVE' ? 'badge-active' : 'badge-inactive'}">${product.status}</span></td>
                    <td>
                        <button class="btn-remove" onclick="removeProduct(${product.id})">Remove</button>
                    </td>
                </tr>
            `).join('');
        }

        // Search products
        function searchProducts() {
            const keyword = document.getElementById('productSearch').value.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(keyword)
            );
            displayProducts(filtered);
        }

        // Ban user
        async function banUser(userId) {
            if (confirm('Are you sure you want to ban this user?')) {
                try {
                    await fetch(`${API_URL}/users/${userId}/ban`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    alert('User banned successfully');
                    loadUsers();
                } catch (error) {
                    console.error('Error banning user:', error);
                }
            }
        }

        // Unban user
        async function unbanUser(userId) {
            try {
                await fetch(`${API_URL}/users/${userId}/unban`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                alert('User unbanned successfully');
                loadUsers();
            } catch (error) {
                console.error('Error unbanning user:', error);
            }
        }

        // Remove product
        async function removeProduct(productId) {
            if (confirm('Are you sure you want to remove this product?')) {
                try {
                    await fetch(`${API_URL}/products/${productId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    alert('Product removed successfully');
                    loadProducts();
                } catch (error) {
                    console.error('Error removing product:', error);
                }
            }
        }

        // Load and display categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/categories`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const categories = await response.json() || [];
                const tbody = document.getElementById('categoriesTableBody');
                
                if (categories.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No categories found</td></tr>';
                    return;
                }

                tbody.innerHTML = categories.map(cat => `
                    <tr>
                        <td>${cat.name}</td>
                        <td>${allProducts.filter(p => p.category === cat.name).length}</td>
                        <td>
                            <button class="btn-remove" onclick="deleteCategory(${cat.id}, '${cat.name}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading categories:', error);
                document.getElementById('categoriesTableBody').innerHTML = '<tr><td colspan="3" style="text-align: center;">Error loading categories</td></tr>';
            }
        }

        // Add category
        async function addCategory() {
            const categoryName = document.getElementById('newCategory').value.trim();
            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        name: categoryName,
                        description: '',
                        imageUrl: '',
                        icon: 'üìÅ'
                    })
                });

                if (response.ok) {
                    alert('Category added successfully');
                    document.getElementById('newCategory').value = '';
                    loadCategories();
                } else {
                    alert('Failed to add category');
                }
            } catch (error) {
                console.error('Error adding category:', error);
                alert('Error adding category');
            }
        }

        // Delete category
        async function deleteCategory(categoryId, categoryName) {
            if (confirm('Delete category "' + categoryName + '"?')) {
                try {
                    const response = await fetch(`${API_URL}/categories/${categoryId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });

                    if (response.ok) {
                        alert('Category deleted');
                        loadCategories();
                    } else {
                        alert('Failed to delete category');
                    }
                } catch (error) {
                    console.error('Error deleting category:', error);
                    alert('Error deleting category');
                }
            }
        }

        // Load dashboard on page load
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (!token || user.role !== 'ADMIN') {
                window.location.href = 'login.html';
            } else {
                document.getElementById('adminName').textContent = 'Hi, ' + user.name;
                loadDashboard();
            }
        });
    </script>
</body>
</html>
